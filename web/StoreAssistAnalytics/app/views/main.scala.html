<!DOCTYPE html>

<html>
<head>
	<title>Store Analytics</title>
	<link href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.2/css/bootstrap.min.css" rel="stylesheet">
	<link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
	
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/highcharts/3.0.2/highcharts.js" type="text/javascript"></script>
	
	<script src="@routes.Assets.at("javascripts/commons.js")" type="text/javascript"></script>
</head>
<body>
	<header class="well">
		<h1 align="center">
			<i class="fa fa-shopping-cart text-error"></i>&nbsp;<b><a
				href="@routes.ReportingController.index()">Store Assist Analytics ..</a></b>
		</h1>
	</header>

	<div class="container">
	
        <!-- Report Filters -->	
		<div class="form-inline">
			<span> 
			     <label for="report_type"><b>Report</b></label> 
			     <select id="report_type" name="report_type">
					<option value="overall_search" selected="selected">Overall Search Summary</option>
					<option value="item_search">Item Search Summary</option>
					<option value="time_search">Time Search Summary</option>
			</select>
			</span> 
			<span> 
			     <label for="start_time"><b>Start Time</b></label> 
			     <input type="date" name="start_time" id="start_time">
			</span> 
			<span> 
			     <label for="end_time"><b>End Time</b></label> 
			     <input type="date" name="end_time" id="end_time">
			</span>
        
            <span>
                <button id="submit_report" class="btn btn-primary">Submit</button>
            </span>
        </div>
		
        <br/>
        
		<div id="report_chart">
		</div>
	</div>
	
	<script type="text/javascript">
	$(document).ready(function () {
		
		// Generate relevant report when submit button in clicked
		$("#submit_report").on("click", function() {
			var startTime = $("#start_time").val();
			var endTime = $("#end_time").val();
			var reportType = $("#report_type").val();
			
			console.log(startTime + ',' + endTime + ',' + reportType)
			if(reportType == "overall_search") {
				console.log("Loading overall search report ..");
				loadOverallSummaryChart(startTime, endTime);
			}
			else if (reportType == "item_search") {
                console.log("Loading item search summary report ..");
                loadItemSearchSummaryReport(startTime, endTime);
			}
			else {
                console.log("Loading time-based search summary report ..");
                loadTimeBasedSearchSummaryReport(startTime, endTime);
			}
		});
		
		// function to generate the overall summary pie chart
		function loadOverallSummaryChart(startTime, endTime)
		{
			var itemSummary = [];
	        $.ajax({
	             type: 'GET',
	             async: false,
	             url: 'http://localhost:9000/report?reportType=overall_search&=startTime=' + startTime + '&endTime=' + endTime,
	             dataType: 'json',
	             success: function(data, textStatus, xhr) {
	                 $.each(data, function (item, frequency) {
	                	 itemSummary.push([item, frequency]);
	                 });
	             }
	         });
	        
	        console.log(itemSummary);
	        
	        var options = getDefaultPieChartOptions();
	        options.chart.renderTo = "report_chart";
	        options.series[0].data = itemSummary;
	        
            options.title.text = 'Overall Item Search Summary Report';
            options.subtitle.text = 'Time : (' + startTime + ',' + endTime + ')';
            
            options.tooltip.formatter = function() {
                return '<b>Item:</b> '+ this.point.name +
                    ', <b>Percentage</b> '+ this.percentage.toFixed(2) +' %';
            }
            
            var chart = new Highcharts.Chart(options);
		}
		
		// function to generate item-based search summary report
		function loadItemSearchSummaryReport(startTime, endTime)
		{
			console.log("Item search summary report ..");
			
			var timeTokens = [];
			var searchFrequencies = [];
            $.ajax({
                type: 'GET',
                async: false,
                url: 'http://localhost:9000/report?reportType=item_search&=startTime=' + startTime + '&endTime=' + endTime,
                dataType: 'json',
                success: function(data, textStatus, xhr) {
                    $.each(data, function (time_token, frequency) {
                    	timeTokens.push(time_token);
                    	searchFrequencies.push(frequency);
                    });
                }
            });
            
            console.log(searchFrequencies);
            console.log(timeTokens);
            
            var options = getDefaultLineChartOptions();
            options.chart.renderTo = "report_chart";
            options.series[0].data = searchFrequencies;
            options.series[0].type = 'line';
            options.series[0].name = 'Item Search History';
            
            options.title.text = 'Item Search Summary Report';
            options.subtitle.text = 'Time : (' + startTime + ',' + endTime + ')';
            
            options.xAxis.title.text = 'Time';
            options.xAxis.categories = timeTokens;
            options.yAxis.title.text = 'Number of searches';

            options.tooltip.formatter = function() {
                return '<b>Time:</b> '+ this.x +
                    ', <b>Searches:</b> '+ this.y;
            }
            
            options.title.text = 'Item Search Summary Report';
            options.subtitle.text = 'Time : (' + startTime + ',' + endTime + ')';
            
			var chart = new Highcharts.Chart(options);
		}
		
		// function to generate time-based item search summary report
		function loadTimeBasedSearchSummaryReport(startTime, endTime)
		{
            console.log("Item search summary report ..");
            
            var timeTokens = [];
            var searchFrequencies = [];
            $.ajax({
                type: 'GET',
                async: false,
                url: 'http://localhost:9000/report?reportType=time_search&=startTime=' + startTime + '&endTime=' + endTime,
                dataType: 'json',
                success: function(data, textStatus, xhr) {
                    $.each(data, function (time_token, frequency) {
                        timeTokens.push(time_token);
                        searchFrequencies.push(frequency);
                    });
                }
            });
            
            console.log(searchFrequencies);
            console.log(timeTokens);
            
            var options = getDefaultLineChartOptions();
            options.chart.renderTo = "report_chart";
            options.series[0].data = searchFrequencies;
            options.series[0].type = 'column';
            options.series[0].name = 'Time-Based Search History';
            
            options.title.text = 'Time-Based Search Summary Report';
            options.subtitle.text = 'Time : (' + startTime + ',' + endTime + ')';
            
            options.xAxis.title.text = 'Time';
            options.xAxis.categories = timeTokens;
            options.yAxis.title.text = 'Number of searches';

            options.tooltip.formatter = function() {
                return '<b>Time:</b> '+ this.x +
                    ', <b>Searches:</b> '+ this.y;
            }
            
            options.title.text = 'Time-Based Search Summary Report';
            options.subtitle.text = 'Time : (' + startTime + ',' + endTime + ')';
            
            var chart = new Highcharts.Chart(options);			
		}
		
	});
	</script>
</body>
</html>
